sap.ui.define(["sap/ui/core/UIComponent","sap/ui/Device","com/sap/bmi/scp/apps/complaintforms/model/models"],function(e,t,s){"use strict";return e.extend("com.sap.bmi.scp.apps.complaintforms.Component",{metadata:{manifest:"json"},init:function(){e.prototype.init.apply(this,arguments);this.getRouter().initialize();this.setModel(s.createDeviceModel(),"device");var t="";var o="";var a="";try{t=this.getOwnerComponent().getComponentData().startupParameters;o=t.taskModel;a=o.getData().InstanceID;var i=`/comsapbmiscpappscomplaintforms/bpmworkflowruntime/v1/task-instances/${a}/context`;var l=new sap.ui.model.json.JSONModel(i);l.setDefaultBindingMode(sap.ui.model.BindingMode.TwoWay);this.setModel(l);var r=this;l.attachRequestCompleted(function(){r.getModel("oLocalJsonModel").setProperty("/Arbitrated",this.getData().Arbitrated==="undefined"?"":this.getData().Arbitrated);r.getModel("oLocalJsonModel").setProperty("/CurrentStatus",this.getData().StatusUpdate.SettlementTrackingUpdate.ApprovalList.CurrentStatus==="undefined"?"":this.getData().StatusUpdate.SettlementTrackingUpdate.ApprovalList.CurrentStatus);r.getModel("oLocalJsonModel").setProperty("/ApprovalLevel",this.getData().ApprovalLevel==="undefined"?"":this.getData().ApprovalLevel);r.getModel("oLocalJsonModel").setProperty("/ApprovalList",this.getData().StatusUpdate.SettlementTrackingUpdate.ApprovalList==="undefined"?"":this.getData().StatusUpdate.SettlementTrackingUpdate.ApprovalList);r.getModel("oLocalJsonModel").setProperty("/ComplaintDesc",this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.Name==="undefined"?"":this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.Name);r.getModel("oLocalJsonModel").setProperty("/ComplaintId",this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.ObjectID==="undefined"?"":this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.ObjectID);r.getModel("oLocalJsonModel").setProperty("/ComplaintDesc",this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.Name==="undefined"?"":this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.Name);r.getModel("oLocalJsonModel").setProperty("/Account",this.getData().Messages.Message2.ServiceRequestPartyCollection.ServiceRequestParty.ObjectID==="undefined"?"":this.getData().Messages.Message2.ServiceRequestPartyCollection.ServiceRequestParty.ObjectID);r.getModel("oLocalJsonModel").setProperty("/ComplaintCategory",this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.ServiceCategoryID==="undefined"?"":this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.ServiceCategoryID);r.getModel("oLocalJsonModel").setProperty("/ComplaintReason",this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.ZComplaintReason_KUT==="undefined"?"":this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.ZComplaintReason_KUT);r.getModel("oLocalJsonModel").setProperty("/TotalCost",this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.Z_CostAllocationcontent_KUT==="undefined"?"":this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.Z_CostAllocationcontent_KUT);r.getModel("oLocalJsonModel").setProperty("/TotalCostCurrency",this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.Z_CostAllocationcurrencyCode_KUT==="undefined"?"":this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.Z_CostAllocationcurrencyCode_KUT);r.getModel("oLocalJsonModel").setProperty("/CostAllocation",this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.ZCostAllocation_KUT==="undefined"?"":this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.ZCostAllocation_KUT);r.getModel("oLocalJsonModel").setProperty("/ImmediateSettlement",this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.Z_ImmediateSettlement_Header_KUT==="undefined"?"":this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.Z_ImmediateSettlement_Header_KUT);r.getModel("oLocalJsonModel").setProperty("/CostSplit",this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.Z_CostSplit_New_KUT==="undefined"?"":this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.Z_CostSplit_New_KUT);r.getModel("oLocalJsonModel").setProperty("/CustomerCountry",this.getData().Messages.Message2.ServiceRequestPartyCollection.ServiceRequestParty.CountryCode==="undefined"?"":this.getData().Messages.Message2.ServiceRequestPartyCollection.ServiceRequestParty.CountryCode);r.getModel("oLocalJsonModel").setProperty("/SettlementReference",this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.Z_Settlementwithreference_KUT==="undefined"?"":this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.Z_Settlementwithreference_KUT);r.getModel("oLocalJsonModel").setProperty("/Invoice_Ref_ID",this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.RefInvoiceID_KUT==="undefined"?"":this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.RefInvoiceID_KUT);r.getModel("oLocalJsonModel").setProperty("/Delivery_Ref_ID",this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.Z_RefDeliveryID_KUT==="undefined"?"":this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.Z_RefDeliveryID_KUT);r.getModel("oLocalJsonModel").setProperty("/Other_Ref_Reason",this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.Z_OtherReferenceReason_KUT==="undefined"?"":this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.Z_OtherReferenceReason_KUT);r.getModel("oLocalJsonModel").setProperty("/ComplaintsStatus",this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.ServiceRequestUserLifeCycleStatusCode==="undefined"?"":this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.ServiceRequestUserLifeCycleStatusCode);r.getModel("oLocalJsonModel").setProperty("/LineItem",this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.ServiceRequestItem.ServiceRequestItem.ID==="undefined"?"":this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.ServiceRequestItem.ServiceRequestItem.ID);r.getModel("oLocalJsonModel").setProperty("/Product",this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.ServiceRequestItem.ServiceRequestItem.ProductID==="undefined"?"":this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.ServiceRequestItem.ServiceRequestItem.ProductID);r.getModel("oLocalJsonModel").setProperty("/ProductDescription",this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.ServiceRequestItem.ServiceRequestItem.Description==="undefined"?"":this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.ServiceRequestItem.ServiceRequestItem.Description);r.getModel("oLocalJsonModel").setProperty("/SettlementMethod",this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.ServiceRequestItem.ServiceRequestItem.UserServiceTransactionProcessingTypeCode==="undefined"?"":this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.ServiceRequestItem.ServiceRequestItem.UserServiceTransactionProcessingTypeCode);r.getModel("oLocalJsonModel").setProperty("/Quantity",this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.ServiceRequestItem.ServiceRequestItem.RequestedQuantity==="undefined"?"":this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.ServiceRequestItem.ServiceRequestItem.RequestedQuantity);r.getModel("oLocalJsonModel").setProperty("/SettlementAmount",this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.ServiceRequestItem.ServiceRequestItem.Z_SettlementAmountcontent_KUT==="undefined"?"":this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.ServiceRequestItem.ServiceRequestItem.Z_SettlementAmountcontent_KUT);r.getModel("oLocalJsonModel").setProperty("/PrincipalPlant",this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.ServiceRequestItem.ServiceRequestItem.ZPlantCode_SDK==="undefined"?"":this.getData().Messages.Message1.ServiceRequestCollection.ServiceRequest.ServiceRequestItem.ServiceRequestItem.ZPlantCode_SDK);r.getModel("oLocalJsonModel").setProperty("/Comments",this.getData().Comments==="undefined"?"":this.getData().Comments);var e="Approve";var s="ApprovedN";var o={sBtnTxt:e,onBtnPressed:function(e){var t=r.getModel();t.refresh(true);r._triggerComplete(a,s,jQuery.proxy(r._refreshTask,r))}};t.inboxAPI.addAction({action:o.sBtnTxt,label:o.sBtnTxt,type:"Accept"},o.onBtnPressed);var i=this.getData().ButtonText.Result[0].ButtonText.ButtonText;var l;l="Rejected";if(i==="Arbitrate"){l="Arbitrate"}var n={sBtnTxt:i,taskStatus:l,onBtnPressed:function(e){var t=r.getModel();t.refresh(true);r._triggerComplete(a,l,jQuery.proxy(r._refreshTask,r))}};t.inboxAPI.addAction({action:n.sBtnTxt,label:n.sBtnTxt,type:"Reject"},n.onBtnPressed)})}catch(e){return}},_triggerComplete:function(e,t,s){var o=new sap.m.BusyDialog;o.open();o.setBusyIndicatorDelay(4e3);if(this.getModel("oLocalJsonModel").getProperty("/ComplaintApprovalReason")===undefined||this.getModel("oLocalJsonModel").getProperty("/ComplaintApprovalReason")===""){o.close();sap.m.MessageBox.error("Enter comment");return}var a=this.byId("ApproverScreen").getId();var i=this.getModel("oLocalJsonModel").getProperty("/CurrentStatus");var l=this.getModel("oLocalJsonModel").getProperty("/ApprovalLevel");var r;var n={};r=n;var c=new Date;var d=this.getModel("oLocalJsonModel").getProperty("/ComplaintsStatus");if(t==="ApprovedN"){var v=this.getModel("oLocalJsonModel").getProperty("/ApprovalList");var g,p;if(l==="1"){g=v.Level1.split("(")[0];p=g+"(Approved)";v.Level1=p;i="Pending for level 2 approval"}else if(l==="2"){g=v.Level2.split("(")[0];p=g+"(Approved)";v.Level2=p;i="Pending for level 3 approval"}else if(l==="3"){g=v.Level3.split("(")[0];p=g+"(Approved)";v.Level3=p;i="Pending for level 4 approval"}else{g=v.Level4.split("(")[0];p=g+"(Approved)";v.Level4=p;i=""}this.getModel("oLocalJsonModel").setProperty("/ApprovalList",v);var u,M,S,R;if(!this.getModel("oLocalJsonModel").getData().ApprovalList.Level1){u=""}else{u=this.getModel("oLocalJsonModel").getData().ApprovalList.Level1}if(!this.getModel("oLocalJsonModel").getData().ApprovalList.Level2){M=""}else{M=this.getModel("oLocalJsonModel").getData().ApprovalList.Level2}if(!this.getModel("oLocalJsonModel").getData().ApprovalList.Level3){S=""}else{S=this.getModel("oLocalJsonModel").getData().ApprovalList.Level3}if(!this.getModel("oLocalJsonModel").getData().ApprovalList.Level4){R=""}else{R=this.getModel("oLocalJsonModel").getData().ApprovalList.Level4}var m=this.byId(a+"--"+"IdInpCostSplit").getValue();var C=this.byId(a+"--"+"IdInpCostAllocation").getValue();var L=this.getModel("oLocalJsonModel").getProperty("/ComplaintsStatus");var q=++l;r='{ "status":"COMPLETED","context": {"approvedorreject": "'+t+'","Comments" : "'+this.getModel("oLocalJsonModel").getData().ComplaintApprovalReason+'","Arbitrated":"'+"Approved"+'","ApprovalLevel": "'+q+'","StatusUpdate":{"Complaintsstatus":"'+L+'","CostAllocation":"'+C+'","CostSplit":"'+m+'","SettlementTrackingUpdate":{\t"ApprovalList" : {"Level1":"'+u+'" ,"Level2":"'+M+'","Level3":"'+S+'","Level4":"'+R+'","LastUpdated":"'+c+'",\t"CurrentStatus":"'+i+'"}}},"Messages":{"Message1":{"ServiceRequestCollection":{"ServiceRequest":{"Z_CostSplit_New_KUT":"'+m+'","ZCostAllocation_KUT":"'+C+'"}}}} }}'}else if(t==="Arbitrate"){if(l==="1"){this.byId(a+"--"+"IdInpCostSplit").setEditable(true);this.byId(a+"--"+"IdInpCostAllocation").setEditable(true);this.byId(a+"--"+"IdInpComments").setEditable(true);o.close();return}else{i=this.getModel("oLocalJsonModel").getProperty("/CurrentStatus");var h=i.split(" ",4)[3]-1;i="Pending for level "+h+" approval";q=--l;v=this.getModel("oLocalJsonModel").getData().ApprovalList;if(l===1){g=v.Level1.split("(")[0];p=g+"(Arbitrate)";v.Level1=p}else if(l===2){g=v.Level2.split("(")[0];p=g+"(Arbitrate)";v.Level2=p}else if(l===3){g=v.Level3.split("(")[0];p=g+"(Arbitrate)";v.Level3=p}else if(l===4){g=v.Level4.split("(")[0];p=g+"(Arbitrate)";v.Level4=p}else{return}if(d==="Z7"){d="Y2"}else{d="Y7"}r='{ "status":"COMPLETED","context": {"approvedorreject": "'+t+'","Comments" : "'+this.getModel("oLocalJsonModel").getData().ComplaintApprovalReason+'","Arbitrated":"'+"Arbitrate"+'","ApprovalLevel": "'+q+'","StatusUpdate":{"SettlementTrackingUpdate":{"ApprovalList" : {"Level1":"'+v.Level1+'" ,"Level2":"'+v.Level2+'","Level3":"'+v.Level3+'","Level4":"'+v.Level4+'","LastUpdated":"'+c+'"}},"Complaintsstatus": "'+d+'"}} }'}}else if(t==="Rejected"){q=l;i="Rejected by Level "+q;v=this.getModel("oLocalJsonModel").getData().ApprovalList;if(l==="1"){g=v.Level1.split("(")[0];p=g+"(Rejected)";v.Level1=p}else if(l==="2"){g=v.Level2.split("(")[0];p=g+"(Rejected)";v.Level2=p}else if(l==="3"){g=v.Level3.split("(")[0];p=g+"(Rejected)";v.Level3=p}else if(l==="4"){g=v.Level4.split("(")[0];p=g+"(Rejected)";v.Level4=p}else{return}r='{ "status":"COMPLETED","context": {"approvedorreject": "'+t+'","Comments" : "'+this.getModel("oLocalJsonModel").getData().ComplaintApprovalReason+'","Arbitrated":"'+"Rejected"+'","ApprovalLevel": "'+q+'","StatusUpdate":{"SettlementTrackingUpdate":{"ApprovalList" : {"Level1":"'+v.Level1+'" ,"Level2":"'+v.Level2+'","Level3":"'+v.Level3+'","Level4":"'+v.Level4+'","LastUpdated":"'+c+'",\t"CurrentStatus":"'+i+'"}}} }}'}else{return}var D=this._fetchToken();$.ajax({url:"/comsapbmiscpappscomplaintforms/bpmworkflowruntime/rest/v1/task-instances/"+e,method:"PATCH",contentType:"application/json",data:r,headers:{"X-CSRF-Token":D},success:s});this.byId(a+"--"+"IdInpComments").setEditable(false);this.byId(a+"--"+"IdInpCostSplit").setEditable(false);this.byId(a+"--"+"IdInpCostAllocation").setEditable(false);o.close()},_refreshTask:function(){var e=this.getComponentData().startupParameters.taskModel.getData().InstanceID;this.getComponentData().startupParameters.inboxAPI.updateTask("NA",e)},_fetchToken:function(){var e;$.ajax({url:"/comsapbmiscpappscomplaintforms/bpmworkflowruntime/rest/v1/xsrf-token",method:"GET",async:false,headers:{"X-CSRF-Token":"Fetch"},success:function(t,s,o){e=o.getResponseHeader("X-CSRF-Token")},error:function(e,t,s){this.onErrorCall()}.bind(this)});return e}})});